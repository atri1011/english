# 故事 1.2: 用户数据模式与数据库设置

## Status
Ready for Review

## Story
**作为一个** 开发者, 
**我想要** 建立 Supabase 项目并为用户及他们加密后的API配置定义好数据库模式, 
**以便于** 我们有一个安全、可靠的基础来存储所有用户数据。

## Acceptance Criteria
1.  一个新的 Supabase 项目已创建并与 Vercel 项目连接。
2.  `users` 表已创建，并与 Supabase 的认证（Auth）服务集成。
3.  一个独立的 `user_api_configs` 表已创建，包含 `user_id`（关联用户）、`api_url`、`encrypted_api_key` 和 `model_name` 等字段。
4.  `encrypted_api_key` 字段绝不能以明文形式存储 API 密钥。
5.  数据库已启用行级安全（RLS）策略，确保用户只能访问和修改自己的 API 配置。

## Tasks / Subtasks
- [x] Task 1: 创建并配置 Supabase 项目 (AC: 1)
  - [x] 在 Supabase 官网创建一个新项目。
  - [x] 在 Vercel 项目设置中，将 Supabase 项目集成进来。
  - [x] 将 Supabase URL 和 `anon` key 添加到 Vercel 的环境变量中。
- [x] Task 2: 设置数据库表 (AC: 2, 3, 4)
  - [x] 在 Supabase SQL 编辑器中，执行脚本创建 `user_api_configs` 表。 [参考: `architecture/7-database-schema.md`]
  - [x] 验证 `users` 表是否已由 Supabase Auth 自动创建和管理。
  - [x] 确保 `user_api_configs` 表的 `user_id` 列正确关联到 `auth.users(id)`。
- [x] Task 3: 启用行级安全 (RLS) (AC: 5)
  - [x] 为 `user_api_configs` 表启用 RLS。 [参考: `architecture/7-database-schema.md`]
  - [x] 应用 RLS 策略，确保用户只能访问和修改自己的数据。 [参考: `architecture/7-database-schema.md`]
- [x] Task 4: 验证数据库设置 (AC: All)
  - [x] 手动在 `auth.users` 表中创建一个测试用户。
  - [x] 尝试以该用户的身份插入一条记录到 `user_api_configs` 表中。
  - [x] 验证该用户可以读取和更新自己刚刚插入的记录。
  - [x] 验证该用户无法访问其他用户的记录（如果存在）。

## Dev Notes

### Previous Story Insights
故事 1.1 `(1.1.project-initialization-deployment-setup.md)` 建立了项目的基本结构和部署流程，但尚未包含任何后端或数据库集成。此故事是第一个引入后端数据持久性的故事。

### 数据库技术栈
[Source: `architecture/3-tech-stack.md`]
- **数据库**: Supabase (PostgreSQL) 15+
- **认证**: Supabase Auth

### 数据模型和模式
[Source: `architecture/4-data-models.md`, `architecture/7-database-schema.md`]
此故事需要实现 `UserApiConfig` 数据模型。

**SQL Schema for `user_api_configs`:**
```sql
-- 用户API配置表
CREATE TABLE public.user_api_configs (
  user_id UUID NOT NULL PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  api_url TEXT NOT NULL,
  encrypted_api_key TEXT NOT NULL,
  model_name TEXT NOT NULL,
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**TypeScript Interface (`packages/shared-types/src/index.ts`):**
```typescript
export interface UserApiConfig {
  user_id: string;
  api_url: string;
  // API Key is never exposed to the client
  model_name: string;
}
```

### 行级安全 (RLS) 策略
[Source: `architecture/7-database-schema.md`]
必须为 `user_api_configs` 表启用 RLS 并应用以下策略，以确保数据隔离和安全：

```sql
-- 启用RLS
ALTER TABLE public.user_api_configs ENABLE ROW LEVEL SECURITY;

-- RLS策略: 用户只能操作自己的配置
CREATE POLICY "Users can manage their own API config"
ON public.user_api_configs FOR ALL
USING (auth.uid() = user_id);
```

### 项目结构注意事项
[Source: `architecture/8-unified-project-structure.md`]
- Supabase 客户端的初始化和配置代码应放置在 `apps/web/lib/supabase/` 目录中。虽然本故事主要是数据库操作，但开发人员应注意将来代码的存放位置。

### 技术约束
- 严禁在数据库中以明文形式存储 `api_key`。`encrypted_api_key` 字段必须存放加密后的值。加密逻辑将在后续故事 (1.6) 中实现，但在表结构设计时必须遵守此约束。
- `users` 表由 Supabase Auth 自动管理，不应手动创建或修改其核心结构。
- 必须启用并验证 RLS 策略。
