# 故事 1.4: 用户登录与会话管理

## Status
Ready for Review

## Story
**作为一个** 已注册用户, 
**我想要** 使用我的邮箱和密码登录，并在不同浏览器会话中保持登录状态, 
**以便于** 我可以方便、安全地访问我的账户。

## Acceptance Criteria
1.  应用提供一个包含邮箱和密码输入框的登录表单。
2.  成功登录后，用户被重定向到应用主页。
3.  应用能够通过会话（Session）机制，在用户关闭并重新打开浏览器后保持其登录状态。
4.  应用提供一个功能明确的“退出登录”按钮，点击后能清除用户的会话。
5.  当输入的凭证不正确时，会向用户显示清晰的错误提示。

## Tasks / Subtasks
- [x] Task 1: 创建登录页面UI (AC: 1)
    - [x] 在 `apps/web/app/(auth)/login/page.tsx` 创建登录页面。 [参考: `architecture/8-unified-project-structure.md`]
    - [x] 使用 Shadcn/ui 组件构建一个包含邮箱、密码输入框和提交按钮的表单。 [参考: `architecture/3-tech-stack.md`]
- [x] Task 2: 实现登录逻辑 (AC: 2, 3)
    - [x] 在表单提交时，调用 Supabase Auth 的 `signInWithPassword` 方法。 [参考: `architecture/3-tech-stack.md`]
    - [x] 成功登录后，将用户重定向到主页 (`/`)。
    - [x] 确保 Supabase 客户端配置为使用 cookie 来自动管理会话。
- [x] Task 3: 实现退出登录功能 (AC: 4)
    - [x] 在应用中（例如，导航栏）添加一个“退出登录”按钮。
    - [x] 点击按钮时，调用 Supabase Auth 的 `signOut` 方法。
- [x] Task 4: 实现错误处理 (AC: 5)
    - [x] 捕获 `signInWithPassword` 方法可能抛出的错误。
    - [x] 当凭证无效时，向用户显示相应的错误信息。
- [x] Task 5: 添加测试 (AC: All)
    - [x] 为登录表单组件编写单元/集成测试，验证其渲染、用户交互和错误处理。 [参考: `architecture/10-testing-strategy.md`]

## Dev Notes

### Previous Story Insights
故事 1.3 `(1.3.user-registration.md)` 成功实现了用户注册流程。此故事将利用已创建的用户凭证来完成认证循环。

### 认证技术
[Source: `architecture/3-tech-stack.md`]
- **认证服务**: Supabase Auth。将使用 Supabase 客户端库 (`@supabase/supabase-js`) 的 `signInWithPassword` 方法进行用户登录，并使用 `signOut` 方法退出登录。
- **会话管理**: Supabase 客户端库通过浏览器 Cookie 自动处理会话管理和持久化，无需手动干预。

### 数据模型
[Source: `architecture/4-data-models.md`]
- 此故事将与由 Supabase Auth 自动管理的 `User` 模型进行交互。无需直接操作数据库表。

### 项目结构注意事项
[Source: `architecture/8-unified-project-structure.md`]
- 登录页面必须创建在 `apps/web/app/(auth)/login/` 目录下。
- 应用的核心布局应在 `apps/web/app/(main)/layout.tsx` 中，并应包含“退出登录”按钮的逻辑。

### 测试要求
[Source: `architecture/10-testing-strategy.md`]
- 必须为登录表单组件 (`apps/web/app/(auth)/login/page.tsx`) 提供单元/组件测试。
- 测试应覆盖表单的成功提交、用户输入验证以及错误信息的显示。

### 技术约束
- 必须使用 Supabase Auth 提供的 `signInWithPassword` 功能来处理用户登录。
- 不得在客户端代码中硬编码任何敏感信息。所有与 Supabase 的交互都应通过公共的 `anon` key 进行。

## Dev Agent Record

### Debug Log
- 测试最初失败，因为 `@supabase/auth-helpers-nextjs` 模块没有安装。
- 我发现项目使用了新的 `@supabase/ssr` 库，并更新了代码以使用它。
- 部署失败，因为在多个文件中 `createServerClient()` 调用缺少必需的参数。
- 修复了 `apps/web/app/(auth)/login/page.tsx` 中的客户端组件 Supabase 客户端初始化问题。
- 修复了 `apps/web/app/layout.tsx` 中的服务端组件 Supabase 客户端初始化问题，添加了正确的 cookies 处理配置。
- 修复了 `apps/web/src/components/AuthButton.tsx` 中的客户端组件 Supabase 客户端初始化问题。
- 创建了 `.env.example` 文件来定义必需的环境变量。

### Completion Notes
- 已成功实现用户登录功能。
- 已成功实现用户注销功能。
- 已成功实现错误处理。
- 已成功为登录表单编写测试。
- 已修复部署失败问题，确保 Supabase 客户端正确初始化。

### File List
- `apps/web/app/(auth)/login/page.tsx`: 已创建登录页面和逻辑。
- `apps/web/src/components/AuthButton.tsx`: 已创建认证按钮组件。
- `apps/web/app/layout.tsx`: 已更新主布局以包含认证按钮。
- `apps/web/app/(auth)/login/page.test.tsx`: 已创建登录页面的测试。
- `apps/web/jest.setup.js`: 已更新 Jest 设置以模拟 Supabase 模块。
- `.env.example`: 已创建环境变量示例文件。

### Change Log
- 将 `@supabase/auth-helpers-nextjs` 替换为 `@supabase/ssr`。
- 修复了多个文件中的 `createServerClient()` 调用问题，确保正确的参数传递。
- 在服务端组件中添加了正确的 cookies 处理配置。
- 在客户端组件中使用正确的 `createClient()` 函数。

## QA Results

### Review Date: 2025-09-02

### Reviewed By: Quinn (Test Architect)

### Code Quality Assessment

The overall implementation quality is good, adhering to the project's tech stack and architecture. The logic for login, session management, and error handling is correctly implemented. However, a critical gap was identified in test coverage for the `AuthButton` component, which has been addressed. Additionally, a minor configuration error in the login page's test setup was corrected.

### Refactoring Performed

- **File**: `apps/web/src/components/AuthButton.test.tsx`
  - **Change**: Created this new test file to provide full test coverage for the `AuthButton` component.
  - **Why**: The component is critical for user authentication (logout functionality) and previously had no tests, violating the testing strategy.
  - **How**: The new tests validate the button's rendering for both logged-in and logged-out states and confirm that `signOut` and navigation actions are called correctly.

- **File**: `apps/web/app/(auth)/login/page.test.tsx`
  - **Change**: Corrected the Supabase client mock to use `createClient` instead of `createServerClient`.
  - **Why**: The original test was mocking the wrong module, which could lead to inaccurate test results and maintenance issues. The test was passing by coincidence.
  - **How**: Updated the import and the mock setup to align with the actual implementation in `LoginPage`, ensuring the test accurately reflects the component's dependencies.

### Compliance Check

- Coding Standards: ✓
- Project Structure: ✓
- Testing Strategy: ✓ (Now compliant after adding missing tests)
- All ACs Met: ✓

### Improvements Checklist

- [x] Added missing unit tests for `AuthButton.tsx`.
- [x] Corrected inaccurate mock in `login/page.test.tsx`.

### Security Review
- The implementation correctly uses Supabase for authentication and avoids exposing sensitive credentials on the client-side. No major vulnerabilities were found.

### Performance Considerations
- No performance issues were identified for this feature.

### Files Modified During Review
- `apps/web/src/components/AuthButton.test.tsx` (Created)
- `apps/web/app/(auth)/login/page.test.tsx` (Modified)

### Gate Status
- Gate: **CONCERNS** → See gate file for details. The initial lack of testing for a critical auth component raises concerns, though it has now been remediated.

### Recommended Status
- ✓ Ready for Done