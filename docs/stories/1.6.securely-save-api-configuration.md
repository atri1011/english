# 故事 1.6: 安全保存 API 配置

## Status
 Approved

## Story
**作为一个** 已登录用户, 
**我想要** 在我保存 API 配置时，系统能够安全地加密并存储我的 API 密钥, 
**以便于** 保护我的凭证信息不被泄露。

## Acceptance Criteria
1.  用户点击“保存”时，表单数据会被发送到一个安全的后端 Serverless Function。
2.  该后端功能在将 API 密钥存入数据库前，必须对其进行加密处理。
3.  API 密钥在数据库的任何地方都绝不能以明文形式存储。
4.  API URL 和模型名称与加密后的密钥一同被保存或更新。
5.  保存成功后，前端界面会给用户一个明确的成功提示。
6.  后端功能必须验证操作者身份，确保用户只能修改自己的配置。

## Tasks / Subtasks
- [ ] Task 1: 创建 API 端点 (AC: 1, 6)
    - [ ] 在 `apps/web/app/api/user/config/route.ts` 创建一个 POST 路由处理器。 [参考: `architecture/8-unified-project-structure.md`]
    - [ ] 从请求中获取用户会话，以验证用户身份。
- [ ] Task 2: 实现加密逻辑 (AC: 2, 3)
    - [ ] 实现一个安全的加密方法来加密 API 密钥。
    - [ ] **关键**: 确保加密密钥通过环境变量安全管理，绝不硬编码。
- [ ] Task 3: 实现数据持久化 (AC: 4)
    - [ ] 使用 Supabase 客户端将加密后的密钥、API URL 和模型名称保存到 `user_api_configs` 表中。 [参考: `architecture/7-database-schema.md`]
- [ ] Task 4: 实现前端集成 (AC: 5)
    - [ ] 更新 `apps/web/app/(main)/settings/page.tsx` 中的保存功能，以调用新的 POST API 端点。
    - [ ] 在成功保存后，向用户显示一个 toast 通知。
- [ ] Task 5: 添加测试 (AC: All)
    - [ ] 为新的 API 路由编写单元测试。 [参考: `architecture/10-testing-strategy.md`]
    - [ ] 模拟请求并验证：未授权的请求被拒绝、有效的请求会调用加密和数据库服务、密钥绝不会在响应中返回。

## Dev Notes

### Previous Story Insights
故事 1.5 (`1.5.api-configuration-page.md`) 创建了用于输入 API 配置的前端页面。此故事将实现该页面的后端逻辑。

### 数据模型
[Source: `architecture/4-data-models.md`]
- 此故事将与 `UserApiConfig` 数据模型交互。
- 后端将接收 `api_url`、`api_key` 和 `model_name`。`api_key` 字段在存入数据库前必须被加密为 `encrypted_api_key`。

### API 规范
[Source: `architecture/5-api-specification.md`]
- 此故事将实现 `POST /api/user/config` 端点。
- **Request Body**: `{ "api_url": "string", "api_key": "string", "model_name": "string" }`
- **Response**: `200 OK` (成功), `401 Unauthorized` (未登录), `400 Bad Request` (无效请求)

### 项目结构注意事项
[Source: `architecture/8-unified-project-structure.md`]
- 后端 API 路由必须创建在 `apps/web/app/api/user/config/route.ts`。

### 技术约束
[Source: `architecture/3-tech-stack.md`]
- 后端逻辑必须使用 Next.js API Routes 和 TypeScript 实现。
- 数据库交互必须通过 Supabase 客户端完成。

### 测试要求
[Source: `architecture/10-testing-strategy.md`]
- 必须为 `/api/user/config` 的 POST 路由提供单元测试。
- 测试需要覆盖认证、加密和数据保存逻辑。