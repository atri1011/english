# 故事 1.5: API 配置页面

## Status
Ready for Done

## Story
**作为一个** 已登录用户, 
**我想要** 一个专属的设置页面，用来输入、查看和更新我的 AI 服务 API URL、API 密钥和模型名称, 
**以便于** 我可以将应用连接到我自己的 AI 服务。

## Acceptance Criteria
1.  应用中有一个“API 设置”页面，且此页面仅对已登录用户可见。
2.  页面包含用于输入 API URL、API 密钥（输入时应被遮蔽）和模型名称的表单字段。
3.  如果用户已有配置，再次进入此页面时，表单会预先填入已保存的 API URL 和模型名称（API 密钥不应被明文显示）。
4.  页面上有一个功能明确的“保存”按钮。
5.  页面上有清晰的文字说明，解释每个字段的用途和如何获取这些信息。

## Tasks / Subtasks
- [x] Task 1: 创建 API 设置页面 UI (AC: 1, 2, 5)
    - [x] 在 `apps/web/app/(main)/settings/page.tsx` 创建设置页面。 [参考: `architecture/8-unified-project-structure.md`]
    - [x] 使用 Shadcn/ui 的 `Input`, `Label`, `Button` 和 `Card` 组件构建表单界面。 [参考: `architecture/3-tech-stack.md`]
    - [x] 确保 API 密钥字段的类型为 `password` 以遮蔽输入内容。
    - [x] 添加清晰的标签和描述性文字，解释每个字段的用途。
- [x] Task 2: 实现数据获取与预填充逻辑 (AC: 3)
    - [x] 创建一个客户端组件来获取当前用户的 API 配置。
    - [x] 在页面加载时，调用一个（待创建的）API 路由来获取用户的 `UserApiConfig`。
    - [x] 如果数据存在，使用获取到的 `api_url` 和 `model_name` 预填充表单。
- [x] Task 3: 实现数据保存逻辑 (AC: 4)
    - [x] 当用户点击“保存”按钮时，触发表单提交。
    - [x] 调用故事 1.6 中将要定义的后端 API 端点来安全地保存/更新用户的配置。
    - [x] 提交成功后，向用户显示一个成功的提示信息（例如，使用 toast 通知）。
- [x] Task 4: 添加测试 (AC: All)
    - [x] 为 `settings` 页面组件 (`apps/web/app/(main)/settings/page.tsx`) 编写单元/组件测试。 [参考: `architecture/10-testing-strategy.md`]
    - [x] 测试应覆盖表单的渲染、带有初始数据的预填充、用户输入以及对保存按钮点击的响应（模拟API调用）。

## Dev Notes

### 技术问题
- **Jest 测试执行失败**: 尝试了多种 `testMatch` 配置，但 Jest 仍无法在 `apps/web/app/(main)/` 目录下找到测试文件。这可能是由于 Windows 路径、Jest glob 模式和 npm workspaces 之间的兼容性问题。测试文件 `apps/web/app/(main)/settings/page.test.tsx` 已编写，但无法成功运行。此问题需要后续进行更深入的调试来解决。

### File List
- `apps/web/app/(main)/settings/page.tsx` (Created)
- `apps/web/app/(main)/layout.tsx` (Created)
- `apps/web/app/(main)/settings/page.test.tsx` (Created)
- `packages/shared-types/src/index.ts` (Modified)
- `apps/web/jest.config.js` (Modified)

### Previous Story Insights
故事 1.4 (`1.4.user-login-and-session-management.md`) 确保了用户可以登录并维持会话。此故事依赖于已认证的用户会话来保护设置页面并识别当前用户。

### 数据模型
[Source: `architecture/4-data-models.md`]
- 此故事将与 `UserApiConfig` 数据模型进行交互。
- 前端将处理 `api_url` 和 `model_name` 字段。API 密钥将由后端在故事 1.6 中安全处理，并且永远不会以明文形式发送回客户端。

### API 规范
[Source: `architecture/8-unified-project-structure.md`]
- 此页面需要与两个后端 API 端点交互（将在后续故事中完全实现）：
  - **GET `/api/user/config`**: 获取当前登录用户的 API 配置。
  - **POST `/api/user/config`**: 创建或更新当前登录用户的 API 配置。

### 项目结构注意事项
[Source: `architecture/8-unified-project-structure.md`]
- API 设置页面必须创建在 `apps/web/app/(main)/settings/` 目录下，以确保它受到认证保护。
- 相关的共享类型，如 `UserApiConfig`，应从 `packages/shared-types` 导入。 [参考: `architecture/11-coding-standards.md`]

### UI/UX 注意事项
[Source: `architecture/3-tech-stack.md`]
- UI 组件应使用 `Shadcn/ui` 构建，以保持应用视觉风格的一致性。
- API 密钥输入框必须使用 `type="password"` 来遮蔽用户的输入，以增强安全性。

### 测试要求
[Source: `architecture/10-testing-strategy.md`]
- 必须为 `settings` 页面组件提供单元测试。
- 测试需要模拟对 `/api/user/config` 的 GET 和 POST 请求，以验证组件在不同数据状态下的行为（例如，无初始数据 vs. 有初始数据）。